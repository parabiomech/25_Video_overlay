<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Overlay Editor (Universal)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header p { opacity: 0.8; font-size: 0.9em; }

        .main-content { padding: 20px; }

        .upload-section {
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-section:hover { border-color: #3498db; background: #f7f9fc; }

        .video-container { display: none; }
        .video-container.active { display: block; }

        video {
            width: 100%;
            max-height: 500px;
            background: black;
            border-radius: 8px;
            margin-bottom: 15px;
            display: block;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1em;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }

        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }

        .btn-success { background: #2ecc71; color: white; }
        .btn-success:hover { background: #27ae60; }

        .tags-section {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #bdc3c7;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            color: #2c3e50;
            cursor: pointer;
        }

        .tag-item .remove-btn {
            margin-left: 8px;
            color: #e74c3c;
            font-weight: bold;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .step {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #bdc3c7;
        }

        .step.active { background: #3498db; transform: scale(1.2); }

        /* Step 2 Styles */
        .threshold-control {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .preview-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .preview-box {
            flex: 1;
            min-width: 300px;
            text-align: center;
        }

        .preview-box canvas {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        input[type="range"] {
            width: 80%;
            margin: 15px 0;
        }

        /* Step 3 Styles */
        .result-container {
            text-align: center;
            padding: 20px;
        }
        
        #finalCanvas {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ Motion Overlay Editor</h1>
            <p id="stepTitle">Step 1: ì˜¤ë²„ë ˆì´í•  ì‹œì  ì„ íƒ</p>
        </div>

        <div class="main-content">
            <div class="step-indicator">
                <div class="step active" id="step1-dot"></div>
                <div class="step" id="step2-dot"></div>
                <div class="step" id="step3-dot"></div>
            </div>

            <!-- Step 1: Selection -->
            <div id="step1-content">
                <div class="upload-section" id="uploadSection" onclick="document.getElementById('videoInput').click()">
                    <h2>ğŸ“‚ ë¹„ë””ì˜¤ ì—´ê¸°</h2>
                    <p>ëª¨ë“  ë¬¼ì²´(ì‚¬ëŒ, ê³µ, ìŠ¤í†¤ ë“±) ì§€ì›</p>
                    <input type="file" id="videoInput" accept="video/*" style="display: none;">
                </div>

                <div class="video-container" id="videoContainer">
                    <video id="videoPlayer" controls></video>
                    
                    <div class="controls">
                        <button class="btn btn-primary" onclick="addTimepoint()">
                            ğŸ“¸ ì‹œì  ì¶”ê°€ (Space)
                        </button>
                        <button class="btn btn-danger" onclick="clearAll()">
                            ğŸ—‘ï¸ ì´ˆê¸°í™”
                        </button>
                    </div>

                    <div class="tags-section">
                        <h3>ì„ íƒëœ ì‹œì  (<span id="tagCount">0</span>)</h3>
                        <div class="tag-list" id="tagsContainer"></div>
                    </div>

                    <div style="text-align: center;">
                        <button id="toStep2Btn" class="btn btn-success" style="display: none; width: 100%;" onclick="goToStep2()">
                            ë‹¤ìŒ: ê°ì²´ ì¶”ì¶œ ì„¤ì • ğŸ‘‰
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Extraction Config -->
            <div id="step2-content" style="display: none;">
                <div class="threshold-control">
                    <h3>ğŸšï¸ ê°ì²´ ê°ì§€ ë¯¼ê°ë„ ì¡°ì ˆ</h3>
                    <p>ë°°ê²½ê³¼ ë¬¼ì²´ë¥¼ êµ¬ë¶„í•˜ëŠ” ë¯¼ê°ë„ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”. ë¬¼ì²´ê°€ í•˜ì–—ê²Œ ì˜ ë³´ì´ë„ë¡ ì„¤ì •í•˜ì„¸ìš”.</p>
                    <input type="range" id="thresholdSlider" min="10" max="100" value="30" oninput="updatePreview()">
                    <span id="thresholdValue">30</span>
                </div>

                <div class="preview-container">
                    <div class="preview-box">
                        <h4>ì›ë³¸ (ì²« ë²ˆì§¸ ì‹œì )</h4>
                        <canvas id="previewOriginal"></canvas>
                    </div>
                    <div class="preview-box">
                        <h4>ì¶”ì¶œ ë§ˆìŠ¤í¬ ë¯¸ë¦¬ë³´ê¸°</h4>
                        <canvas id="previewMask"></canvas>
                    </div>
                </div>

                <div class="controls" style="margin-top: 30px;">
                    <button class="btn btn-danger" onclick="goToStep1()">ğŸ‘ˆ ë’¤ë¡œê°€ê¸°</button>
                    <button class="btn btn-success" onclick="generateResult()">ê²°ê³¼ ìƒì„±í•˜ê¸° (ì‚¬ì§„ + ì˜ìƒ) ğŸ‘‰</button>
                </div>
            </div>

            <!-- Step 3: Result -->
            <div id="step3-content" class="result-container" style="display: none;">
                <h2>âœ¨ ê²°ê³¼ í™•ì¸</h2>
                
                <div style="margin: 20px 0;">
                    <h3>ğŸ–¼ï¸ í•©ì„± ì‚¬ì§„</h3>
                    <canvas id="finalCanvas"></canvas>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="downloadImage()">
                        ğŸ’¾ ì‚¬ì§„ ì €ì¥
                    </button>
                </div>

                <div style="margin: 40px 0; border-top: 1px solid #eee; padding-top: 20px;">
                    <h3>ğŸ¥ ëª¨ì…˜ íŠ¸ë ˆì¼ ì˜ìƒ</h3>
                    <video id="finalVideo" controls style="width: 100%; max-height: 500px; border-radius: 8px;"></video>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="downloadVideo()">
                        ğŸ’¾ ì˜ìƒ ì €ì¥
                    </button>
                </div>

                <button class="btn btn-danger" onclick="location.reload()">ğŸ”„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h3 id="loadingText">ì²˜ë¦¬ ì¤‘...</h3>
    </div>

    <script>
        const video = document.getElementById('videoPlayer');
        const videoInput = document.getElementById('videoInput');
        
        let timepoints = [];
        let backgroundFrame = null; // Canvas containing the background (first frame)
        let frameData = []; // Stores {time, imageBitmap} for selected timepoints

        // --- Step 1: Setup & Selection ---
        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                video.src = URL.createObjectURL(file);
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('videoContainer').classList.add('active');
            }
        });

        function addTimepoint() {
            const time = video.currentTime;
            if (!timepoints.some(t => Math.abs(t - time) < 0.1)) {
                timepoints.push(time);
                timepoints.sort((a, b) => a - b);
                updateTags();
            }
        }

        function removeTimepoint(index) {
            timepoints.splice(index, 1);
            updateTags();
        }

        function clearAll() {
            timepoints = [];
            updateTags();
        }

        function updateTags() {
            const container = document.getElementById('tagsContainer');
            document.getElementById('tagCount').textContent = timepoints.length;
            container.innerHTML = '';
            
            timepoints.forEach((time, index) => {
                const div = document.createElement('div');
                div.className = 'tag-item';
                div.innerHTML = `<span onclick="video.currentTime=${time}">${time.toFixed(2)}s</span> <span class="remove-btn" onclick="removeTimepoint(${index})">Ã—</span>`;
                container.appendChild(div);
            });

            document.getElementById('toStep2Btn').style.display = timepoints.length > 0 ? 'block' : 'none';
        }

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && video.src && document.getElementById('step1-content').style.display !== 'none') {
                e.preventDefault();
                video.paused ? video.play() : (video.pause(), addTimepoint());
            }
        });

        // --- Step 2: Extraction Configuration ---
        async function goToStep2() {
            showLoading('í”„ë ˆì„ ì¶”ì¶œ ì¤‘...');
            
            // 1. Capture Background (Assume 0s or first timepoint is background-ish, or just use 0s)
            // Better: Use the first frame of the video as background reference
            video.currentTime = 0;
            await waitForSeek();
            backgroundFrame = await captureFrame();

            // 2. Capture all selected timepoints
            frameData = [];
            for (let time of timepoints) {
                video.currentTime = time;
                await waitForSeek();
                const frame = await captureFrame();
                frameData.push({ time, frame });
            }

            hideLoading();
            
            // UI Switch
            document.getElementById('step1-content').style.display = 'none';
            document.getElementById('step2-content').style.display = 'block';
            document.getElementById('stepTitle').textContent = 'Step 2: ê°ì²´ ì¶”ì¶œ ì„¤ì •';
            document.getElementById('step1-dot').classList.remove('active');
            document.getElementById('step2-dot').classList.add('active');

            updatePreview();
        }

        function goToStep1() {
            document.getElementById('step2-content').style.display = 'none';
            document.getElementById('step1-content').style.display = 'block';
            document.getElementById('stepTitle').textContent = 'Step 1: ì˜¤ë²„ë ˆì´í•  ì‹œì  ì„ íƒ';
            document.getElementById('step2-dot').classList.remove('active');
            document.getElementById('step1-dot').classList.add('active');
        }

        function updatePreview() {
            const threshold = parseInt(document.getElementById('thresholdSlider').value);
            document.getElementById('thresholdValue').textContent = threshold;

            // Use the first selected timepoint for preview
            if (frameData.length === 0) return;

            const sample = frameData[0];
            const w = video.videoWidth;
            const h = video.videoHeight;

            // Draw Original
            const cvsOrig = document.getElementById('previewOriginal');
            cvsOrig.width = w; cvsOrig.height = h;
            cvsOrig.getContext('2d').drawImage(sample.frame, 0, 0);

            // Draw Mask
            const cvsMask = document.getElementById('previewMask');
            cvsMask.width = w; cvsMask.height = h;
            const ctxMask = cvsMask.getContext('2d');
            
            // Generate Mask
            const maskData = generateDifferenceMask(sample.frame, backgroundFrame, threshold, w, h);
            ctxMask.putImageData(maskData, 0, 0);
        }

        function generateDifferenceMask(targetImg, bgImg, threshold, w, h) {
            // Create temporary canvases to get pixel data
            const c1 = document.createElement('canvas'); c1.width = w; c1.height = h;
            const ctx1 = c1.getContext('2d');
            ctx1.drawImage(targetImg, 0, 0);
            const data1 = ctx1.getImageData(0, 0, w, h).data;

            const c2 = document.createElement('canvas'); c2.width = w; c2.height = h;
            const ctx2 = c2.getContext('2d');
            ctx2.drawImage(bgImg, 0, 0);
            const data2 = ctx2.getImageData(0, 0, w, h).data;

            const result = ctx1.createImageData(w, h);
            const resData = result.data;

            for (let i = 0; i < data1.length; i += 4) {
                const rDiff = Math.abs(data1[i] - data2[i]);
                const gDiff = Math.abs(data1[i+1] - data2[i+1]);
                const bDiff = Math.abs(data1[i+2] - data2[i+2]);
                
                const diff = (rDiff + gDiff + bDiff) / 3;

                if (diff > threshold) {
                    resData[i] = 255;   // R
                    resData[i+1] = 255; // G
                    resData[i+2] = 255; // B
                    resData[i+3] = 255; // Alpha
                } else {
                    resData[i] = 0;
                    resData[i+1] = 0;
                    resData[i+2] = 0;
                    resData[i+3] = 255; // Black background for mask preview
                }
            }
            return result;
        }

        // --- Step 3: Generation ---
        async function generateResult() {
            showLoading('ê²°ê³¼ ìƒì„± ì¤‘...');
            const threshold = parseInt(document.getElementById('thresholdSlider').value);
            const w = video.videoWidth;
            const h = video.videoHeight;

            // 1. Generate Static Image
            const finalCanvas = document.getElementById('finalCanvas');
            finalCanvas.width = w; finalCanvas.height = h;
            const ctx = finalCanvas.getContext('2d');

            // Draw Background
            ctx.drawImage(backgroundFrame, 0, 0);

            // Overlay Objects
            for (let item of frameData) {
                const mask = generateDifferenceMask(item.frame, backgroundFrame, threshold, w, h);
                applyMaskAndDraw(ctx, item.frame, mask, w, h);
            }

            // 2. Generate Video
            await generateVideo(threshold, w, h);

            hideLoading();
            
            // UI Switch
            document.getElementById('step2-content').style.display = 'none';
            document.getElementById('step3-content').style.display = 'block';
            document.getElementById('stepTitle').textContent = 'Step 3: ê²°ê³¼ í™•ì¸';
            document.getElementById('step2-dot').classList.remove('active');
            document.getElementById('step3-dot').classList.add('active');
        }

        function applyMaskAndDraw(targetCtx, sourceImg, maskData, w, h) {
            const tempC = document.createElement('canvas');
            tempC.width = w; tempC.height = h;
            const tempCtx = tempC.getContext('2d');
            
            // Draw source
            tempCtx.drawImage(sourceImg, 0, 0);
            const sourceData = tempCtx.getImageData(0, 0, w, h);
            
            // Apply mask to alpha channel
            for (let i = 0; i < sourceData.data.length; i += 4) {
                // If mask is black (0), make transparent
                if (maskData.data[i] === 0) {
                    sourceData.data[i+3] = 0;
                }
            }
            
            tempCtx.putImageData(sourceData, 0, 0);
            
            // Draw to target
            targetCtx.globalAlpha = 0.8; // Slight transparency
            targetCtx.drawImage(tempC, 0, 0);
            targetCtx.globalAlpha = 1.0;
        }

        async function generateVideo(threshold, w, h) {
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            
            const stream = canvas.captureStream(30); // 30 FPS
            const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            const chunks = [];
            
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const videoUrl = URL.createObjectURL(blob);
                document.getElementById('finalVideo').src = videoUrl;
                window.finalVideoBlob = blob;
            };
            
            mediaRecorder.start();

            // Play video and draw overlays
            video.currentTime = 0;
            await waitForSeek();
            
            const duration = video.duration;
            const fps = 30;
            const interval = 1/fps;
            
            // Pre-calculate overlays
            const overlays = [];
            for (let item of frameData) {
                const mask = generateDifferenceMask(item.frame, backgroundFrame, threshold, w, h);
                const tempC = document.createElement('canvas');
                tempC.width = w; tempC.height = h;
                const tCtx = tempC.getContext('2d');
                tCtx.drawImage(item.frame, 0, 0);
                const sData = tCtx.getImageData(0, 0, w, h);
                for(let i=0; i<sData.data.length; i+=4) {
                    if(mask.data[i] === 0) sData.data[i+3] = 0;
                }
                tCtx.putImageData(sData, 0, 0);
                overlays.push({ time: item.time, img: tempC });
            }

            // Frame loop
            for (let t = 0; t < duration; t += interval) {
                video.currentTime = t;
                // Note: In a real loop, waiting for seek every frame is slow. 
                // For better performance, we might just play the video and draw in requestAnimationFrame,
                // but for precision export, frame-by-frame is safer.
                await waitForSeek();
                
                ctx.drawImage(video, 0, 0);
                
                // Draw accumulated overlays that have passed
                for (let ov of overlays) {
                    if (t >= ov.time) {
                        ctx.globalAlpha = 0.8;
                        ctx.drawImage(ov.img, 0, 0);
                        ctx.globalAlpha = 1.0;
                    }
                }
                
                // Wait a bit to let recorder catch up (optional but helps stability)
                await new Promise(r => setTimeout(r, 10));
            }
            
            mediaRecorder.stop();
        }

        // Helpers
        function waitForSeek() {
            return new Promise(resolve => {
                const handler = () => {
                    video.removeEventListener('seeked', handler);
                    resolve();
                };
                video.addEventListener('seeked', handler);
            });
        }

        async function captureFrame() {
            return createImageBitmap(video);
        }

        function showLoading(msg) {
            document.getElementById('loadingText').textContent = msg;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'overlay_result.png';
            link.href = document.getElementById('finalCanvas').toDataURL();
            link.click();
        }

        function downloadVideo() {
            if (window.finalVideoBlob) {
                const link = document.createElement('a');
                link.download = 'motion_trail.webm';
                link.href = URL.createObjectURL(window.finalVideoBlob);
                link.click();
            }
        }
    </script>
</body>
</html>